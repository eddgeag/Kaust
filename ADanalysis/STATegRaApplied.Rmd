---
title: "Multi Omic Data explioration"
author: "Edmond GÃ©raud Aguilar"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
 prettydoc::html_pretty:
    toc: true
    theme: cayman
    highlight: github
    number_sections: true
bibliography: references.bibtex
link-citations: true
linkcolor: blue
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
# knitr options
knitr::opts_chunk$set(comment = NA, prompt = TRUE, tidy.opts=list(width.cutoff=60),tidy=TRUE, 
               fig.width = 7, fig.height = 7,echo = TRUE, 
               message = T, warning =T, cache=T,fig.pos = "!H", out.extra = "")
```

```{r librerias}
library(GEOquery)
library(ggplot2)
library(GGally)
library(chisq.posthoc.test)
library(limma)
library(DESeq2)
library(Rsubread)
```

# Description of original publication of data-set to be applied

## RNA-seq

## Setup environment

```{r setupNevironment}
dir.create("./results")
```



## Metadata analysis


```{r downloadMetaData}
metadata.file<-"./data/rnaseqData/metadata.csv"
metadata.raw<-read.csv(file = metadata.file,header = T,sep = ",",dec = ".")
w<-unlist(apply(metadata.raw, 2, function(x) which(is.na(x))))
metadata<-metadata.raw[-w,]
# kableExtra::kable(metadata)
kableExtra::kable(metadata)

```

### Descriptive analysis for each feature. 

We have gender, age ath death, post mortem hours, Braak and Cerad soroes, integrity numbers for RNA, and percentage of neurons (they don't specify what it is)

Let's see first classify cause of death by complications of AD and others, and also, convert into factors, group, gender, Cerad, Braak into factors.

```{r preparandoMetadata}
colnames(metadata)<-c("ID","Group","Gender","AgeDeath","PMI","Braak","Cerad","RIN_RNA","neuron","CauseDeath") ## column names chaged for easy manipulation

## Classifiying cause of death
w<-grep("AD",metadata$CauseDeath)
metadata$CauseDeath[w]<-"ADcomp"
metadata$CauseDeath[-w]<-"Other"
## characters to factos
for(j in 1:ncol(metadata)){
  
  if(class(metadata[,j])=="character"){
    metadata[,j]<-as.factor(metadata[,j])
  }
  
}
```

Let's se how the data is finally
```{r preparandoMetadata2}
metadata.copy<-metadata[,-1]# let's remove the index
metadata.copy$Group2<-as.factor(ifelse(metadata$Group!="AD","control","AD"))
str(metadata.copy)
```
#### Descriptve numerical statistics 

First of all let's observe the min, max, the quartiles, and the mean, for numerical variables, and the categorical variables, his levels.

```{r}
kableExtra::kable(summary(metadata.copy))
```

At first sight one can observe that the PMI feature, is some how imbalance, in the way that the mean and the median are not close to each others. For the other numerical variables, it seems that the data follows a normal distribution, given the fact that the mean and the median are close to each other. We have 12 patients with AD, and 18 controls, 10 Old and 8 Young. We have 3 females and 27 males. From the Braak stage, we have I/II in 5 samples. and 12 samples in V/VI stage. From Cerad score, we only have the 12 patients with AD. 

#### Descriptive Plots

Let's look how the data is described.
```{r generalPlotsCategorical}
par(mfrow=c(3,2))
for ( i in 1:dim(metadata.copy)[2]) {
  if (class(metadata.copy[,i])=="factor"){
      plot(metadata.copy[,i],main=colnames(metadata.copy)[i])}
}
```

```{r generalplotsCont}
par(mfrow=c(1,2))
for ( i in 1:dim(metadata.copy)[2]) {
  if (class(metadata.copy[,i])!="factor"){
      boxplot(metadata.copy[,i],main=colnames(metadata.copy)[i])
      points(mean(metadata.copy[,i]),col="blue")
      hist(metadata.copy[,i],main=colnames(metadata.copy[,i]),freq = F,xlab=colnames(metadata.copy[,i]))
      lines(density(metadata.copy[,i]),col="blue")
    
    }
}
```

From the above plots, one can see that we have odd numbers between controls and AD subjects. Also, we have only one female per group. Qualitatively, all the continuous variables do not appear to be  normal distributions. 

Just to observe, if all the continuous features follow normal distributions, between the the controls groups and the AD group or not. 

```{r plotsContVarvsGroups}
par(mfrow=c(2,2))
for ( i in 1:dim(metadata.copy)[2]) {
  if (class(metadata.copy[,i])!="factor"){
      boxplot(metadata.copy[,i]~metadata.copy$Group,main=colnames(metadata.copy)[i],
              ylab = colnames(metadata.copy)[i],xlab = "")
      means<-tapply(metadata.copy[,i], metadata.copy$Group, mean)
      points(means,col="blue")
    
    }
}

```


```{r plotsContrlCategorical}

x<-metadata.copy[,c(2,5,6,9)]
y<-apply(x, 2, function(column) table(metadata.copy$Group,column))
par(mfrow=c(2,2))
for( i in 1:length(y)){
  y.t<-y[[i]]
  barplot(y.t,xlim=c(0,ncol(y.t)+3),
          col=1:3,
          ylab="Subjects",
          legend.text=T,
          args.legend=list(
            x=ncol(y.t)+3,
            y=max(colSums(y.t)),
            bty="n"
          ))
  
  
}
```


#### Analysis betwwen groups and other features

```{r testhomogeneityNormality}
with(metadata.copy,bartlett.test(AgeDeath~Group))

with(metadata.copy,bartlett.test(PMI~Group))

with(metadata.copy,bartlett.test(RIN_RNA~Group))

with(metadata.copy,bartlett.test(neuron~Group))

with(metadata.copy,shapiro.test(AgeDeath))

with(metadata.copy,shapiro.test(PMI))

with(metadata.copy,shapiro.test(RIN_RNA))

with(metadata.copy,shapiro.test(neuron))


```
It seems that there is no heterogeneity of variances, and although there are only 30 samples, Shapiro-Wilks test tell us that the normality holds. Thus we are going to perform anova test with Bonferroni correction in all continuous features compared with groups.

```{r aovDeath}
summary(with(metadata.copy,aov(AgeDeath~Group)))
pairwise.t.test(metadata.copy$AgeDeath,metadata.copy$Group,method="bonferroni")
```
Performing anova over the controls and AD subjects, we can observe that there are statistican significance between old , young, AD, young subjects. But there is not statistical significance between Old and AD subjects.
```{r anovaPMI}
summary(with(metadata.copy,aov(PMI~Group)))
```
Anova indicating that there is not significance evidence between the post mortem interval between subjects. 
```{r rinRNAanova}
summary(with(metadata.copy,aov(RIN_RNA~Group)))
pairwise.t.test(metadata.copy$RIN_RNA,metadata.copy$Group,method="bonferroni")
```
The integrity numbers of RNA shows a statsitical evidence between AD and Young subjects. But there is no difference between old and young controls. 
```{r statisticalAnalysisMetadata}
summary(with(metadata.copy,aov(neuron~Group)))
pairwise.t.test(metadata.copy$neuron,metadata.copy$Group,method="bonferroni")
```
The percentage of neurons gives us a statistical evidence of change between old-young and AD-young subjects. 
```{r}
chisq.test(table(metadata.copy$Gender,metadata.copy$Group))
chisq.posthoc.test(table(metadata.copy$Braak,metadata.copy$Group))
chisq.posthoc.test(table(metadata.copy$Cerad,metadata.copy$Group))
chisq.posthoc.test(table(metadata.copy$CauseDeath,metadata.copy$Group))

```
Making a chisq test for proportions, one can observe, that obviusly there are significance evidence between female and male subjects ( there is only one female per group). Between groups and Braak stages, there are statstical evidence between AD 

# Question !
Before going into the exploratory analysis, we have observed that RIN-RNA and neuron \% differs statsitically speaking from controls and AD. For that reason, let's convert those numerical variables into categories. For the integrity of RNA lets add another variable, with low and high integrity of RNA based on their means. And we will do the same for \% neuron. Low percentage and high percentage.

# RNA-seq exploratory analysis


## Loading the superseries and RNA-seq subseries
```{r cargaDtos}
# gse.superserie<-getGEO("GSE153875",destdir = "data/superserie",GSEMatrix = T)
# gse.GSE130746<-getGEO("GSE130746",destdir = "ADdata/subseries/gse130746_chip_seq/",GSEMatrix = T) #chip-seq
gse.GSE153873<-getGEO("GSE153873",destdir = "data/rnaseqData/",GSEMatrix = T) # RNA-seq
counts<-read.csv("./data/rnaseqData/GSE153873_summary_count.star.txt",header = T,sep = "\t",row.names="refGene")
```

First let's investigate which T and A refer, and how they possible lines to metadata. Furthermore lets contrusct this data frame as a "targets" in which will go the pheno data.

```{r targetsFile}
title<-gse.GSE153873$GSE153873_series_matrix.txt.gz$title
title.temp<-matrix(strsplit2(title,"-"),ncol=3)
title.temp.df<-as.data.frame(title.temp)
colnames(title.temp.df)<-c("ID","dontknow","Group")

title.temp.df$shortname<-paste(title.temp.df$Group,title.temp.df$dontknow,title.temp.df$ID,sep="_")
title.temp.df$ID<-as.numeric(title.temp.df$ID)
title.temp.df.ordered<-title.temp.df[order(title.temp.df$ID),]
title.temp.df.ordered$dontknowID<-as.numeric(rownames(title.temp.df.ordered))
w<-which(title.temp.df.ordered$dontknow%in%title.temp.df.ordered$dontknow[grep("A",title.temp.df.ordered$dontknow)])
title.temp.df.ordered$dontknowLetter<-numeric(length(nrow(title.temp)))
title.temp.df.ordered$dontknowLetter[w]<-"A"
title.temp.df.ordered$dontknowLetter[-w]<-"T"
targets.temp<-cbind(title.temp.df.ordered,metadata.copy)
```


```{r investigando2}
targets.temp2<-targets.temp[,-c(3)]
rownames(targets.temp2)<-targets.temp2$shortname
targets<-targets.temp2[,-3]
for ( i in 1:ncol(targets)){
  
  if(class(targets[,i])=="character")
    targets[,i]<-as.factor(targets[,i])
  
  
}

boxplot(targets[,c(3,7,8,11,12)])
boxplot(targets$dontknowID~targets$dontknowLetter)
hist(targets$dontknowID)
wilcox.test(targets$dontknowID~targets$dontknowLetter)
wilcox.test(targets$dontknowID,targets$PMI)
wilcox.test(targets$dontknowID,targets$AgeDeath)
ftable(table(targets$Group,targets$dontknowLetter,targets$Gender,targets$Braak,targets$Cerad))
```
A represents females subjects, each of one for each group. From AD female, we have a Cerad socre and Braak stage V/VI. From Old female subject, we have a no Cerad score and I/II Braak stage. Young female has no Braak stages neither Cerad score. 



Afterwards, we are going to construct a `summarizedExperiment` an object from DESeq. First of all we are going to reorder the samples.



```{r reordering}
write.csv(targets,file="./results/targets.csv",sep=",")
coldata<-targets
for( j in 1:ncol(targets)){
  
  if(class(targets[,j])=="character"){
    coldata[,j]<-as.factor(coldata[,j])
  }
}

col.namez<-strsplit2(colnames(counts),split="[.]")
col.namez[,1]<-gsub("X","",col.namez[,1])
col.namez.df<-as.data.frame(col.namez)
colnames(col.namez.df)<-c("ID","dontknow","Group")
col.namez.df$ID<-as.numeric(col.namez.df$ID)
counts.order<-counts[,order(col.namez.df$ID)]
col.namez.df$shortName<-paste(col.namez.df$Group,col.namez.df$dontknow,col.namez.df$ID,sep="_")
col.namez.df$shortName.ordered<-col.namez.df$shortName[order(col.namez.df$ID)]
counts.order<-counts[,order(col.namez.df$ID)]
colnames(counts.order)<-col.namez.df$shortName.ordered
head(counts.order)
```
# Further anslysis



```{r investigandoMisterioso}
par(mfrow=c(2,2))
for ( i in 1:dim(targets)[2]) {
  if (class(targets[,i])=="factor"){
    if(colnames(targets)[i]!="dontknow"){
      boxplot(targets$dontknowID~targets[,i],main=colnames(targets)[i],
              ylab = "Dontknow ID",xlab = "")
      # means<-tapply(targets[,i], targets[,i], mean)
      # points(means,col="blue")
    
    }
}}


```
```{r}
wilcox.test(targets$dontknowID~targets$dontknowLetter)
```
```{r}
kruskal.test(targets$dontknowID~targets$Group)
```
```{r}
wilcox.test(targets$dontknowID~targets$Gender)
```
```{r}
wilcox.test(targets$dontknowID~targets$Cerad)
```

```{r}
kruskal.test(targets$dontknowID~targets$Braak)
```


```{r investigandoMAsvariableMisteriosaN}

x<-targets[,c(4,5,6,9,10,13,14)]
y<-apply(x, 2, function(column) table(metadata.copy$Group,column))
par(mfrow=c(2,2))
for( i in 1:length(y)){
  y.t<-y[[i]]
  barplot(y.t,xlim=c(0,ncol(y.t)+3),
          col=1:3,
          ylab="DontKnowLeter",
          legend.text=T,
          args.legend=list(
            x=ncol(y.t)+3,
            y=max(colSums(y.t)),
            bty="n"
          ))
  
  
}
```


```{r constructObject}
dds<-DESeqDataSetFromMatrix(countData = counts.order,colData=targets,design=~dontknowID+dontknowLetter+Group+Gender+PMI+RIN_RNA+neuron)

```

## Pre-filtering the dataset

Here we apply the most minimal filtering rule: removing rows of the `DESeqDataSet` that have no counts, or only a single count across all samples. Additional weighting/filtering to improve power is applied later.

```{r minimalFiltering}

nrow(dds)
keep<-rowSums(counts(dds)) >1
dds.filt<-dds[keep,]
```

Here we filter the counts in such order that the number of samples would be set to the smalles group size, here "Young".

```{r}
keep<-rowSums(counts(dds.filt)>=10)>=8
dds.filt2<-dds.filt[keep,]
```

## The variance stabilizing transformation and the rlog

### rlog vs VST


```{r vsd}
vsd<-vst(dds.filt2,blind=FALSE)
head(assay(vsd),3)
```

```{r vsd2}
  colData(vsd)
```
```{r rld}
# rld<-rlog(dds.filt2,blind=F)
# head(assay(rld),3)
```
```{r}

```

